name: Auto Close Conflicted PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  issues: write

jobs:
  check-mergeability:
    runs-on: ubuntu-latest

    steps:
      - name: Check PR mergeability
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');

            async function getPRWithRetry(owner, repo, number, maxRetries = 3, delayMs = 5000) {
              for (let i = 0; i < maxRetries; i++) {
                const pr = await github.rest.pulls.get({
                  owner,
                  repo,
                  pull_number: number
                });

                const mergeable = pr.data.mergeable;
                if (mergeable !== null) return mergeable;

                console.log(`Attempt ${i + 1}: Mergeable is null, retrying in ${delayMs / 1000}s...`);
                await new Promise(resolve => setTimeout(resolve, delayMs));
              }
              core.setFailed('Mergeability is still unknown after retries.');
              return null;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = context.payload.pull_request.number;

            const isMergeable = await getPRWithRetry(owner, repo, number);

            if (isMergeable === false) {
              console.log('PR has merge conflicts. Closing it.');

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: number,
                body: '⚠️ This pull request has merge conflicts with the base branch and has been closed automatically. Please resolve the conflicts and open a new PR.'
              });

              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: number,
                state: 'closed'
              });
            } else if (isMergeable === true) {
              console.log('PR is mergeable. No action needed.');
            }
