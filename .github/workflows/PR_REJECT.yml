name: Auto Close Conflicted PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-mergeability:
    runs-on: ubuntu-latest

    steps:
      - name: Check PR mergeability
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const isMergeable = pr.data.mergeable;

            // GitHub may return `null` for mergeable if it's still calculating.
            if (isMergeable === false) {
              // Leave a comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: '⚠️ This pull request has merge conflicts and will be closed automatically. Please resolve the conflicts and create a new PR if needed.'
              });

              // Close the PR
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                state: 'closed'
              });
            } else if (isMergeable === null) {
              // Try again later by failing this job (so it can be retried manually or re-run by PR update)
              core.setFailed('Mergeability is unknown at this time. Try again later.');
            } else {
              console.log('PR is mergeable. No action needed.');
            }
