
name: Auto Close PR on Conflict

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize]

jobs:
  check-conflict:
    runs-on: ubuntu-latest

    steps:
      - name: Wait for GitHub to calculate mergeability
        run: sleep 20

      - name: Check for merge conflicts with debug output
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number;

            if (!prNumber) {
              throw new Error("‚ùå No pull request context found. This workflow only works on PR events.");
            }

            let pr;

            for (let i = 0; i < 5; i++) {
              pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              console.log(`üîÅ Attempt ${i + 1}`);
              console.log(`üì¶ PR #${pr.data.number}`);
              console.log(`üìÑ Title: ${pr.data.title}`);
              console.log(`üîß Mergeable: ${pr.data.mergeable}`);

              if (pr.data.mergeable !== null) break;

              await new Promise(resolve => setTimeout(resolve, 5000)); // wait 5 sec
            }

            if (pr.data.mergeable === false) {
              console.log("‚ùå Conflict detected. Closing PR...");

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                body: "‚ùå This PR has merge conflicts and has been closed automatically by GitHub Actions."
              });

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.data.number,
                state: "closed"
              });

              console.log("üõë PR closed.");
            } else if (pr.data.mergeable === true) {
              console.log("‚úÖ PR is clean. No conflicts.");
            } else {
              console.log("‚ö†Ô∏è Mergeable status is still null after 5 retries.");
            }
