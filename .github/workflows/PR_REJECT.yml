name: Auto Close Conflicted PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-mergeability:
    runs-on: ubuntu-latest

    steps:
      - name: Check PR mergeability with retry
        uses: actions/github-script@v7
        with:
          script: |
            async function wait(ms) {
              return new Promise(resolve => setTimeout(resolve, ms));
            }

            const prNumber = context.payload.pull_request.number;
            let attempts = 0;
            let mergeable = null;

            // Retry checking mergeability up to 5 times
            while (mergeable === null && attempts < 5) {
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              mergeable = pr.data.mergeable;
              attempts++;

              if (mergeable === null) {
                console.log(`Mergeability is still unknown (attempt ${attempts}). Waiting 2 seconds...`);
                await wait(2000);
              }
            }

            if (mergeable === false) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: '⚠️ This pull request has merge conflicts and will be closed automatically. Please resolve the conflicts and create a new PR if needed.'
              });

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                state: 'closed'
              });

              console.log('PR had merge conflicts and was closed.');
            } else if (mergeable === null) {
              core.setFailed('Could not determine mergeability after multiple attempts.');
            } else {
              console.log('PR is mergeable. No action needed.');
            }
