name: Auto-Close Conflicted PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  close_conflicted_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Check for merge conflicts
        id: check_conflict
        run: |
          git fetch origin ${{ github.base_ref }}
          CONFLICT=$(git merge --no-commit --no-ff origin/${{ github.base_ref }} || echo "conflict")
          if [[ "$CONFLICT" == "conflict" ]]; then
            echo "has_conflict=true" >> $GITHUB_OUTPUT
          else
            echo "has_conflict=false" >> $GITHUB_OUTPUT
          fi

      - name: Close pull request if conflicted
        if: steps.check_conflict.outputs.has_conflict == 'true'
        uses: peter-evans/close-pull@v3
        with:
          comment: "‚ùå This pull request has merge conflicts and will be closed automatically."
