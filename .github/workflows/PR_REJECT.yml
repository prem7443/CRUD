
name: Auto Close PR on Conflict

on:
  workflow_dispatch:          # ğŸ‘ˆ manual run
  pull_request:               # ğŸ‘ˆ auto run on PR open or update
    types: [opened, synchronize]

jobs:
  check-conflict:
    runs-on: ubuntu-latest

    steps:
    - name: Check for merge conflicts with debug output
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          let pr;

          const pr_number = context.payload.pull_request?.number || 16; // replace 16 for testing if no PR context

          for (let i = 0; i < 5; i++) {
            pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            console.log(`ğŸ” Attempt ${i + 1}`);
            console.log(`ğŸ“¦ PR #${pr.data.number}`);
            console.log(`ğŸ“„ Title: ${pr.data.title}`);
            console.log(`ğŸ”§ Mergeable: ${pr.data.mergeable}`);

            if (pr.data.mergeable !== null) break;

            await new Promise(resolve => setTimeout(resolve, 5000));
          }

          if (pr.data.mergeable === false) {
            console.log("âŒ Conflict detected. Closing PR...");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              body: "âŒ This PR has merge conflicts and has been closed automatically by GitHub Actions."
            });

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.data.number,
              state: "closed"
            });

            console.log("ğŸ›‘ PR closed.");
          } else if (pr.data.mergeable === true) {
            console.log("âœ… PR is clean. No conflicts.");
          } else {
            console.log("âš ï¸ Mergeable status is still null after 5 retries.");
          }
